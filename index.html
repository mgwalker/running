<!DOCTYPE html>
<head lang="en">
  <head>
    <title>My runs, 2021</title>
    <style type="text/css">
      @import url("https://fonts.googleapis.com/css2?family=Public+Sans:wght@100;700&display=swap");

      body {
        font-family: "Public Sans", sans-serif;
      }

      #container {
        display: grid;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        grid-template-columns: 50vw 50vw;
        grid-template-rows: 50vh 50vh;
      }

      #container > * {
        padding: 5px;
      }

      #stats table {
        margin: 0 auto;
      }

      #stats table th {
        padding-right: 5px;
        text-align: right;
      }

      svg {
        max-height: 45vh;
        max-width: 45vw;
      }

      svg .grid-line g.tick line {
        stroke-opacity: 0.1;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="stats">
        <table>
          <tbody>
            <tr>
              <th>Total distance:</th>
              <td id="stats-total-distance"></td>
            </tr>
            <tr>
              <th>Total runs:</th>
              <td id="stats-total-runs"></td>
            </tr>
            <tr>
              <th>Total time:</th>
              <td id="stats-total-time"></td>
            </tr>
            <tr>
              <th>Average distance:</th>
              <td id="stats-average-distance"></td>
            </tr>
            <tr>
              <th>Average pace:</th>
              <td id="stats-average-pace"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="individual"></div>
      <div id="cumulative"></div>
      <div id="pace"></div>
    </div>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="graph.js"></script>
    <script src="run-data.js"></script>
    <script type="text/javascript">
      const square = (data) => {
        // For each day, add the previous day's value as the starting point.
        // Basically we end up with two values for each day - start and end,
        // where start is the previous day's value. This produces a nice little
        // square line chart.
        for (let i = 1; i < data.length; i++) {
          data.splice(i, 0, {
            ...data[i],
            value: data[i - 1].value,
          });
          i += 1;
        }

        // For the last day, go ahead and push on the next day's "start" value,
        // so it's not just a vertical line but it also has a hat.
        const last = data[data.length - 1];
        data.push({
          date: new Date(
            last.date.getFullYear(),
            last.date.getMonth(),
            last.date.getDate() + 1
          ),

          value: last.value,
        });
      };

      const main = async () => {
        const csvUrl =
          "https://gist.githubusercontent.com/mgwalker/de505c85d9225b3a379d2b3bc9342486/raw/runs.csv";

        const dateParser = d3.timeParse("%Y-%m-%d");
        const csv = await d3.csv(csvUrl, (c) => ({
          date: dateParser(c.date),
          distance: +c.distance,
          time: +c.time,
        }));

        const { cumulative, individual, pace, stats } = RunData.process(csv);

        square(individual);
        square(cumulative);
        square(pace);

        const individualGraph = makeGraph(individual);
        const cumulativeGraph = makeGraph(cumulative, { stroke: "green" });
        const paceGraph = makeGraph(pace, {
          stroke: "orange",
          yAxisLabel: "minutes per mile",
        });

        document.getElementById("individual").append(individualGraph.node());
        document.getElementById("cumulative").append(cumulativeGraph.node());
        document.getElementById("pace").append(paceGraph.node());

        document.getElementById(
          "stats-total-distance"
        ).innerText = `${stats.total} miles`;
        document.getElementById(
          "stats-total-runs"
        ).innerText = `${stats.totalRuns}`;
        document.getElementById(
          "stats-total-time"
        ).innerText = `${stats.totalTime}`;
        document.getElementById(
          "stats-average-distance"
        ).innerText = `${stats.averageDistance} miles per run`;
        document.getElementById(
          "stats-average-pace"
        ).innerText = `${stats.averagePace} per mile`;
      };

      main();
    </script>
  </body>
</head>
